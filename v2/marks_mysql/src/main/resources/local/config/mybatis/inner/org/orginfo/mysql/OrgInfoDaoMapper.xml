<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.marks.module.inner.org.orginfo.dao.OrgInfoDao">

	<select id="findById" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		SELECT * FROM TB_ORG_INFO
		orginfo where orginfo.ORGID = #{orgid} or orginfo.LOGOID=#{orgid}
	</select>

	<insert id="save" parameterType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		INSERT INTO TB_ORG_INFO
		(
		ORGID,
		CREATOR,
		ORGNAME,
		CREATETIME,
		UPDATETIME,
		USEFLAG,
		PARENTID,
		LVL,
		COMPANYID,
		ORGTYPEï¼Œ
		LOGOID
		)
		VALUES(
		#{orgid:VARCHAR},
		#{creator:VARCHAR},
		#{orgname:VARCHAR},
		now(),
		now(),
		#{useflag:NUMERIC},
		#{parentId:VARCHAR},
		#{lvl:NUMERIC},
		#{companyId:VARCHAR},
		#{orgType:VARCHAR},
		#{logoId:VARCHAR}
		)
	</insert>

	<update id="update" parameterType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		UPDATE TB_ORG_INFO
		SET
		ORGNAME = #{orgname:VARCHAR},
		UPDATETIME = now(),
		USEFLAG =
		#{useflag:NUMERIC},
		PARENTID=#{parentId:VARCHAR},
		LVL=#{lvl:NUMERIC},
		ORGTYPE=#{orgType:VARCHAR},
		LOGOID=#{logoId:VARCHAR}
		WHERE
		ORGID =
		#{orgid}
	</update>

	<delete id="delete" parameterType="String">
		DELETE FROM TB_ORG_INFO WHERE
		ORGID=#{orgid}
	</delete>

	<select id="findAll" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		SELECT * FROM TB_ORG_INFO t
		where t.USEFLAG=1
		<if test="companyId !=null and companyId !=''">
			and t.COMPANYID=#{companyId}
		</if>
	</select>

	<delete id="deleteBatch" parameterType="java.util.List">
		DELETE FROM TB_ORG_INFO WHERE ORGID in
		<foreach collection="list" item="ids" index="index" open="("
			separator="," close=")">
			#{ids}
		</foreach>
	</delete>
	<select id="frameCombo" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo"
		parameterType="java.util.Map">
		SELECT *
		FROM TB_ORG_INFO orginfo
		WHERE 1=1
		and orginfo.ORGTYPE=1
		<if test="companyId !=null and companyId !=''">
			and orginfo.ORGID=#{companyId}
		</if>
		order by
		orginfo.UPDATETIME desc
	</select>
	<select id="list" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo"
		parameterType="java.util.Map">
		SELECT *
		FROM TB_ORG_INFO orginfo
		WHERE 1=1
		<if test="keyword!=null and keyword!=''">
			and ( orginfo.ORGID LIKE
			CONCAT(CONCAT('%',#{keyword:VARCHAR}),'%')

			or orginfo.CREATOR LIKE
			CONCAT(CONCAT('%',#{keyword:VARCHAR}),'%')

			or orginfo.ORGNAME LIKE
			CONCAT(CONCAT('%',#{keyword:VARCHAR}),'%')

			or
			to_char(orginfo.CREATETIME,'yyyyMMdd') LIKE
			CONCAT(CONCAT('%',#{keyword:VARCHAR}),'%')
			)
		</if>
		and (orginfo.ORGTYPE=1)
		<if test="companyId !=null and companyId !=''">
			and orginfo.COMPANYID=#{companyId}
		</if>
		order by
		orginfo.UPDATETIME desc
	</select>
	<select id="getTreeGridByParentId" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		select t.*,
		p2.orgname parentName,
		(case
		when cnum is null then
		'open'
		else
		'closed'
		end) state
		from tb_org_info t
		left join tb_org_info p2 on
		t.parentid = p2.orgid
		left join (select count(1) cnum, p.parentid pid
		from tb_org_info p
		group by p.parentid) p on t.orgid = p.pid
		where 1=1
		<if test="plist != null">
			AND t.parentid IN
			<foreach collection="plist" item="ids" index="index" open="("
				separator="," close=")">
				#{ids}
			</foreach>
		</if>
		<if test="companyId !=null and companyId !=''">
			and t.COMPANYID=#{companyId}
		</if>
	</select>

	<select id="getChildList" resultType="com.marks.module.inner.org.orginfo.pojo.OrgInfo">
		select * from tb_org_info t
		where t.parentid=#{orgid}
	</select>

	<update id="updateOrgChildNum">
		update tb_org_info t,
		(select t2.parentid,count(1) cnum from tb_org_info t2 group by t2.parentid) b
		set t.childnum=b.cnum
		where b.parentid=t.orgid and t.orgid=#{orgid}
	</update>
</mapper>